{"author":"Gk0Wk","dependents":"","description":"Section editor for TiddlyWiki5","list":"readme LICENSE","name":"sections","plugin-type":"plugin","text":"{\"tiddlers\":{\"$:/plugins/Gk0Wk/sections/readme\":{\"title\":\"$:/plugins/Gk0Wk/sections/readme\",\"type\":\"text/vnd.tiddlywiki\",\"caption\":\"sections-readme\"},\"$:/plugins/Gk0Wk/sections/style.css\":{\"title\":\"$:/plugins/Gk0Wk/sections/style.css\",\"text\":\".gk0wk-section-preview {\\n  position: relative;\\n}\\n.gk0wk-section-preview[collapsed=\\\"yes\\\"] {\\n  margin: 5px 0;\\n}\\n\\n.gk0wk-section-editor-preview-sidebar,\\n.gk0wk-section-editor-editing-sidebar {\\n  position: absolute;\\n  max-height: calc(100% + 10px);\\n  z-index: 1000;\\n  display: flex;\\n  flex-direction: column;\\n  align-items: center;\\n  justify-content: space-around;\\n  transition: all {{$:/config/AnimationDuration}}ms;\\n}\\n.gk0wk-section-preview[collapsed=\\\"yes\\\"] > .gk0wk-section-editor-preview-sidebar {\\n  top: -5px;\\n}\\n.gk0wk-section-preview[collapsed=\\\"no\\\"] > .gk0wk-section-editor-preview-sidebar {\\n  top: -10px;\\n}\\n.gk0wk-section-preview:hover\\n  > .gk0wk-section-editor-preview-sidebar {\\n  opacity: 1;\\n}\\n.gk0wk-section-editor-preview-sidebar[side=\\\"left\\\"] {\\n  height: 50px;\\n  left: -35px;\\n  opacity: 0;\\n}\\n.gk0wk-section-editor-preview-sidebar[side=\\\"right\\\"] {\\n  height: 50px;\\n  right: -35px;\\n  opacity: 0;\\n}\\n.gk0wk-section-editor-editing-sidebar[side=\\\"right\\\"] {\\n  height: 50px;\\n  right: -35px;\\n  top: -10px;\\n}\\n\\n.gk0wk-section-editor-button {\\n  height: 20px;\\n  width: 20px;\\n  cursor: pointer;\\n  display: flex;\\n  align-items: center;\\n  justify-content: center;\\n  opacity: 0.5;\\n  transition: all {{$:/config/AnimationDuration}}ms;\\n}\\n.gk0wk-section-editor-button:hover {\\n  opacity: 1;\\n}\\n\\n.gk0wk-section-editor-section-editing-background,\\n.gk0wk-section-preview[collapsed=\\\"no\\\"] > .gk0wk-section-editor-section-background {\\n  position: absolute;\\n  top: -10px;\\n  bottom: -10px;\\n  left: -10px;\\n  right: -10px;\\n  border-radius: 5px;\\n  z-index: -1;\\n  background: <<colour primary>>;\\n}\\n\\n.gk0wk-section-preview[collapsed=\\\"yes\\\"] > .gk0wk-section-editor-section-background {\\n  position: absolute;\\n  top: -5px;\\n  bottom: -5px;\\n  left: -10px;\\n  right: -10px;\\n  border-radius: 5px;\\n  z-index: -1;\\n  background: <<colour primary>>;\\n}\\n\\n.gk0wk-section-editor-section-background {\\n  background: <<colour primary>>;\\n  opacity: 0;\\n  transition: all {{$:/config/AnimationDuration}}ms;\\n}\\n\\n.gk0wk-section-preview:hover\\n  > .gk0wk-section-editor-section-background,\\n.gk0wk-section-editor-section-editing-background {\\n  opacity: 0.1;\\n}\\n\",\"tags\":\"$:/tags/Stylesheet\",\"type\":\"text/vnd.tiddlywiki\"},\"$:/plugins/Gk0Wk/sections/widget.js\":{\"title\":\"$:/plugins/Gk0Wk/sections/widget.js\",\"module-type\":\"widget\",\"type\":\"application/javascript\",\"Modern.TiddlyDev#Origin\":\"widget/index.ts\",\"text\":\"\\\"use strict\\\";var buttonContent,buttonContent2,buttonContent3,buttonContent4,buttonContent5,buttonContent6,split=t=>{var e,n=$tw.wiki.parseTiddler(t),{tree:d,usingRuleMap:i,sourceLength:r}=n;let s=d;for(;null!=(e=s[0])&&e.rule&&null!=(e=null==(e=i[s[0].rule])?void 0:e.types)&&e.pragma;)s=null!=(e=s[0].children)?e:[];if(0===s.length)return[[0,r],[],n,s];{var o=[],d=[0,s[0].start];let t,e,i=[];for(const l of s)void 0!==l.start&&(t=l.start),void 0!==l.end&&(e=l.end),i.push(l),void 0!==t&&void 0!==e&&(o.push([t,e,i]),t=void 0,e=void 0,i=[]);return 0<o.length&&(o[o.length-1][1]=r),[d,o,n,s]}},SectionBackground=()=>$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"gk0wk-section-editor-section-background\\\"}),CancelButton=(e,i)=>{null==buttonContent&&(buttonContent=$tw.wiki.renderText(\\\"text/html\\\",\\\"text/vnd.tiddlywiki\\\",'<$transclude $tiddler=\\\"$:/core/images/close-button\\\" size=\\\"14px\\\"/>',{parentWidget:e,parseAsInline:!0}));var t=$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"gk0wk-section-editor-button\\\",style:{},attributes:{action:\\\"cancel\\\"},innerHTML:buttonContent});return t.addEventListener(\\\"click\\\",()=>{var t;e.editingSection===i&&(null!=(t=i.editor)&&t.remove(),delete i.editor,i.container.style.display=\\\"\\\",$tw.wiki.deleteTiddler(i.editingTiddler),delete e.editingSection)}),t},SaveButton=(i,n)=>{null==buttonContent2&&(buttonContent2=$tw.wiki.renderText(\\\"text/html\\\",\\\"text/vnd.tiddlywiki\\\",'<$transclude $tiddler=\\\"$:/core/images/done-button\\\" size=\\\"14px\\\"/>',{parentWidget:i,parseAsInline:!0}));var t=$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"gk0wk-section-editor-button\\\",style:{},attributes:{action:\\\"save\\\"},innerHTML:buttonContent2});return t.addEventListener(\\\"click\\\",()=>{var t,e;i.editingSection===n&&(null!=(e=n.editor)&&e.remove(),delete n.editor,n.container.style.display=\\\"\\\",e=$tw.wiki.getTiddlerText(n.editingTiddler),e=`${(t=$tw.wiki.getTiddler(n.tiddler).fields).text.substring(0,n.start).trim()}\\n\\n${e.trim()}\\n\\n`+t.text.substring(n.end).trim(),$tw.wiki.addTiddler(new $tw.Tiddler(t,{text:e})),$tw.wiki.deleteTiddler(n.editingTiddler),delete i.editingSection)}),t},EditingSidebarRight=(t,e)=>{var i=$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"gk0wk-section-editor-editing-sidebar\\\",attributes:{side:\\\"right\\\"}});return i.appendChild(SaveButton(t,e)),i.appendChild(CancelButton(t,e)),i},functionKey=$tw.browser&&/macintosh|mac os x/i.test(navigator.userAgent)?\\\"metaKey\\\":\\\"ctrlKey\\\",AddButton=(l,a)=>{null==buttonContent3&&(buttonContent3=$tw.wiki.renderText(\\\"text/html\\\",\\\"text/vnd.tiddlywiki\\\",'<$transclude $tiddler=\\\"$:/core/images/new-button\\\" size=\\\"14px\\\"/>',{parentWidget:l,parseAsInline:!0}));var t=$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"gk0wk-section-editor-button\\\",style:{},attributes:{action:\\\"add\\\"},innerHTML:buttonContent3});return t.addEventListener(\\\"click\\\",t=>{var e,i,n,d,r,s,o;l.editingSection||(r=l.getSection(a))&&(e=t[functionKey],({start:i,end:n,tiddler:o,container:d}=r),l.editingSection=r,r=`$:/temp/Gk0Wk/section-editor/edit/${o}-${Date.now()}-${e?i:n}-${e?i:n}-new`,$tw.wiki.addTiddler({title:r,text:\\\"\\\"}),$tw.wiki.makeTranscludeWidget(\\\"$:/core/ui/EditTemplate/body\\\",{document:document,parentWidget:l,field:\\\"text\\\",importPageMacros:!0,variables:{currentTiddler:r}}).render(d.parentElement,e?d:d.nextSibling),(s=e?d.previousSibling:d.nextSibling).style.position=\\\"relative\\\",s.insertBefore(EditingSidebarRight(l,o={tiddler:o,start:e?i:n,end:e?i:n,container:d,editingTiddler:r,editor:s}),s.firstChild),s.insertBefore($tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"gk0wk-section-editor-section-editing-background\\\"}),s.firstChild),l.editingSection=o)}),t},DeleteButton=(d,r)=>{null==buttonContent4&&(buttonContent4=$tw.wiki.renderText(\\\"text/html\\\",\\\"text/vnd.tiddlywiki\\\",'<$transclude $tiddler=\\\"$:/core/images/delete-button\\\" size=\\\"14px\\\"/>',{parentWidget:d,parseAsInline:!0}));var t=$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"gk0wk-section-editor-button\\\",style:{},attributes:{action:\\\"delete\\\"},innerHTML:buttonContent4});return t.addEventListener(\\\"click\\\",()=>{var t,e,i,n;d.editingSection||confirm(\\\"确定删除？\\\")&&(n=d.getSection(r))&&(({start:n,end:t,tiddler:e}=n),e=$tw.wiki.getTiddler(e)[\\\"fields\\\"],i=e[\\\"text\\\"],n=i.substring(0,n).trim()+`\\n\\n`+i.substring(t).trim(),$tw.wiki.addTiddler(new $tw.Tiddler(e,{text:n})))}),t},EditButton=(r,s)=>{null==buttonContent5&&(buttonContent5=$tw.wiki.renderText(\\\"text/html\\\",\\\"text/vnd.tiddlywiki\\\",'<$transclude $tiddler=\\\"$:/core/images/edit-button\\\" size=\\\"14px\\\"/>',{parentWidget:r,parseAsInline:!0}));var t=$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"gk0wk-section-editor-button\\\",style:{},attributes:{action:\\\"edit\\\"},innerHTML:buttonContent5});return t.addEventListener(\\\"click\\\",()=>{var t,e,i,n,d;r.editingSection||(t=r.getSection(s))&&(({start:n,end:d,tiddler:i,container:e}=t),r.editingSection=t,e.style.display=\\\"none\\\",i=$tw.wiki.getTiddlerText(i).substring(n,d),n=\\\"$:/temp/Gk0Wk/section-editor/edit/\\\"+s,$tw.wiki.addTiddler({title:n,text:i}),$tw.wiki.makeTranscludeWidget(\\\"$:/core/ui/EditTemplate/body\\\",{document:document,parentWidget:r,field:\\\"text\\\",importPageMacros:!0,variables:{currentTiddler:n}}).render(e.parentElement,e),(d=e.previousSibling).style.position=\\\"relative\\\",d.insertBefore(EditingSidebarRight(r,t),d.firstChild),d.insertBefore($tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"gk0wk-section-editor-section-editing-background\\\"}),d.firstChild),t.editor=d,t.editingTiddler=n)}),t},MenuButton=(t,e)=>{return null==buttonContent6&&(buttonContent6=$tw.wiki.renderText(\\\"text/html\\\",\\\"text/vnd.tiddlywiki\\\",'<$transclude $tiddler=\\\"$:/core/images/menu-button\\\" size=\\\"14px\\\"/>',{parentWidget:t,parseAsInline:!0})),$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"gk0wk-section-editor-button\\\",style:{},attributes:{action:\\\"menu\\\"},innerHTML:buttonContent6})},PreviewSidebarLeft=(t,e)=>{var i=$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"gk0wk-section-editor-preview-sidebar\\\",attributes:{side:\\\"left\\\"}});return i.appendChild(MenuButton(t,e)),i.appendChild(AddButton(t,e)),i},PreviewSidebarRight=(t,e)=>{var i=$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"gk0wk-section-editor-preview-sidebar\\\",attributes:{side:\\\"right\\\"}});return i.appendChild(EditButton(t,e)),i.appendChild(DeleteButton(t,e)),i},import_widget=require(\\\"$:/core/modules/widgets/widget.js\\\"),SectionEditorWidget=class extends import_widget.widget{constructor(){super(...arguments),this.tiddler=\\\"\\\",this.widgets=[],this.sections=new Map}initialise(t,e){super.initialise(t,e),this.computeAttributes()}execute(){this.makeChildWidgets(),this.tiddler=this.getAttribute(\\\"tiddler\\\",\\\"\\\")}render(e,i){if(this.execute(),e&&this.tiddler)if(this.widgets.length=0,$tw.utils.each(this.domNodes,t=>t.remove()),this.domNodes.length=0,this.sections.clear(),$tw.browser){this.parentDomNode=e;var t,n,d,[,r,s,o]=split(this.tiddler),l=[...o],a=Date.now();for([t,n,d]of r){var u=`${this.tiddler}-${a}-${t}-`+n,c=(o.length=0,o.push(...d),$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"gk0wk-section-preview\\\",attributes:{start:t,end:n,tiddler:this.tiddler}})),g=(this.sections.set(u,{tiddler:this.tiddler,start:t,end:n,container:c}),$tw.wiki.makeWidget(s,{parentWidget:this,document:document,variables:{currentTiddler:this.tiddler}}));g.render(c,null),c.insertBefore(PreviewSidebarLeft(this,u),c.firstChild),c.insertBefore(PreviewSidebarRight(this,u),c.firstChild),c.insertBefore(SectionBackground(),c.firstChild),this.widgets.push(g),this.domNodes.push(c),e.insertBefore(c,i),c.setAttribute(\\\"collapsed\\\",c.clientHeight<=30?\\\"yes\\\":\\\"no\\\")}o.length=0,o.push(...l)}else{var w=$tw.utils.domMaker(\\\"div\\\",{});$tw.wiki.makeTranscludeWidget(this.tiddler,{document:document,parentWidget:this,recursionMarker:\\\"yes\\\",field:\\\"text\\\",importPageMacros:!0,variables:{currentTiddler:this.tiddler}}).render(w,null);for(let t=0;t<w.children.length;t++)this.domNodes.push(w.children[t]),e.insertBefore(w.children[t],i)}}refresh(t){var e=this.computeAttributes();if(e.tiddler||e.config||t[this.tiddler])return e=this.findNextSiblingDomNode(),this.render(this.parentDomNode,e),!0;let i=!1;for(const n of this.widgets)i=n.refresh(t)||i;return i||this.refreshChildren()}getSection(t){return this.sections.get(t)}};exports[\\\"section-editor\\\"]=SectionEditorWidget;\"}}}","title":"$:/plugins/Gk0Wk/sections","type":"application/json","version":"0.0.1-alpha1","Modern.TiddlyDev#SHA256-Hashed":"e8a8bd329e0550858ea5a69aa10eb50db2f4c44492f5b9144e314bb68c6b9e68"}