{"title":"$:/plugins/Gk0Wk/chat-gpt","name":"ChatGPT","author":"Gk0Wk","description":"ChatGPT in TiddlyWiki","plugin-type":"plugin","dependents":"$:/plugins/tiddlywiki/markdown","version":"0.0.2","list":"readme config","type":"application/json","text":"{\"tiddlers\":{\"$:/plugins/Gk0Wk/chat-gpt/config\":{\"title\":\"$:/plugins/Gk0Wk/chat-gpt/config\",\"tags\":\"$:/tags/ControlPanel/SettingsTab\",\"type\":\"text/vnd.tiddlywiki\",\"caption\":\"ChatGPT\",\"text\":\"<$list filter=\\\"[[$:/language]get[text]removeprefix[$:/languages/]else[en-GB]]\\\" variable=\\\"lang\\\">\\n<$list filter=\\\"[<lang>search[zh]]\\\">\\n\\n; <$text text=\\\"OpenAI\\\" /> API Key\\n: <$edit-text tiddler=\\\"$:/plugins/Gk0Wk/chat-gpt/openai-api-key\\\" tag=\\\"input\\\" default=\\\"\\\" />\\n: 你应当注册自己的 <$text text=\\\"OpenAI\\\" /> 账号，并申请 [[API Key|https://platform.openai.com/account/api-keys]]。\\n\\n</$list>\\n\\n<$list filter=\\\"[<lang>!search[zh]]\\\">\\n\\n; <$text text=\\\"OpenAI\\\" /> API Key\\n: <$edit-text tiddler=\\\"$:/plugins/Gk0Wk/chat-gpt/openai-api-key\\\" tag=\\\"input\\\" default=\\\"71\\\" />\\n: You should register your <$text text=\\\"OpenAI\\\" /> account and request an [[API Key|https://platform.openai.com/account/api-keys]].\\n\\n</$list>\\n</$list>\\n\"},\"$:/plugins/Gk0Wk/chat-gpt/openai-api-key\":{\"title\":\"$:/plugins/Gk0Wk/chat-gpt/openai-api-key\"},\"$:/plugins/Gk0Wk/chat-gpt/readme\":{\"title\":\"$:/plugins/Gk0Wk/chat-gpt/readme\",\"type\":\"text/vnd.tiddlywiki\",\"caption\":\"ChatGPT\",\"text\":\"<$list filter=\\\"[[$:/language]get[text]removeprefix[$:/languages/]else[en-GB]]\\\" variable=\\\"lang\\\">\\n<$list filter=\\\"[<lang>search[zh]]\\\">\\n\\n在 <$text text=\\\"TiddlyWiki\\\" /> 中使用 <$text text=\\\"<$text text=\\\"ChatGPT\\\" />\\\" />。\\n\\n安装后请首先在[[这里|$:/plugins/Gk0Wk/chat-gpt/config]]填写你的 <$text text=\\\"OpenAI\\\" /> API Key，否则无法使用该插件的功能。\\n\\n你的侧边栏会多出一个 <$text text=\\\"ChatGPT\\\" /> 页面，可以直接进行对话，对话的历史会保存。如要清除历史记录，则直接删除 `history` 参数指向的条目。\\n\\n<$text text=\\\"ChatGPT\\\" /> 实际上是一个微件，你可以按照自己的需求定制聊天机器人：\\n\\n```html\\n<$chat-gpt />\\n```\\n\\n还可以添加各种可选参数来定制行为：\\n\\n|!参数 |!解释 |\\n|history |填写一个条目的标题，用于持久化存储聊天记录 |\\n|scroll |如果为yes，则对话记录可上下滚动，但必须在微件外一层指定高度，参考[[侧边栏|$:/plugins/Gk0Wk/chat-gpt/side-bar]]的写法 |\\n|component |微件的DOM标签类型，默认为div |\\n|className |微件的类名，用于自定义样式 |\\n|readonly |如果为readonly，则不会出现对话输入框，配合history参数仅做展示用 |\\n|system_message |系统消息，用于AI的行为，例如\\\"你是一个经验丰富的律师\\\" |\\n\\n除此之外，还支持如下 <$text text=\\\"ChatGPT\\\" /> 参数：\\n\\n* model\\n* temperature\\n* top_p\\n* max_tokens\\n* presence_penalty\\n* frequency_penalty\\n* user\\n\\n其具体用法可以查看[[官方文档|https://platform.openai.com/docs/api-reference/chat/create]]，或者直接问它好了。\\n\\n现在还没有做多轮对话，即便是在一个微件里聊得，也都是单轮对话，多轮对话等下个版本再搞。\\n\\np.s. 现在使用 ChatGPT 要翻墙，注册账号需要海外手机号，请自行想办法。\\n\\n</$list>\\n\\n<$list filter=\\\"[<lang>!search[zh]]\\\">\\n\\nUsing <$text text=\\\"ChatGPT\\\" /> in <$text text=\\\"TiddlyWiki\\\" />.\\n\\nAfter installation, please fill in your <$text text=\\\"OpenAI\\\" /> API Key [[here|$:/plugins/Gk0Wk/chat-gpt/config]] first, otherwise you will not be able to use the functionality of the plugin.\\n\\nYou will have an additional <$text text=\\\"ChatGPT\\\" /> page in your sidebar, where you can have a conversation directly, and the history of the conversation will be saved. To clear the history, simply delete the entry pointed to by the `history` parameter.\\n\\n<$text text=\\\"ChatGPT\\\" /> is actually a widget that allows you to customize the chatbot according to your needs.\\n\\n```html\\n<$chat-gpt />\\n```\\n\\nVarious optional parameters can also be added to customize the behavior.\\n\\n|!Attributes |!Explanation |\\n|history |Fill in an tiddler title for persistent storage of chat logs |\\n|scroll |If yes, the conversation record can be scrolled up and down, but the height must be specified in the outer layer of the widget, refer to the [[sidebar|$:/plugins/Gk0Wk/chat-gpt/side-bar]] writing |\\n|component |DOM tag type for microware, default is div |\\n|className |Class name of the widget for custom styles |\\n|readonly |If it is readonly, no dialog input box will appear, and it will be used for display only with the history parameter. |\\n|system_message |System messages to customize the AI's behavior, such as \\\"You are an experienced lawyer\\\" |\\n\\n\\nIts specific usage can check the [[official documentation|https://platform.openai.com/docs/api-reference/chat/create]], or just ask it well.\\n\\nNow there is no multi-round dialogue, even in a micro-piece chat, but also a single round of dialogue, multi-round dialogue and so on the next version to engage.\\n\\n</$list>\\n</$list>\\n\"},\"$:/plugins/Gk0Wk/chat-gpt/side-bar\":{\"title\":\"$:/plugins/Gk0Wk/chat-gpt/side-bar\",\"type\":\"text/vnd.tiddlywiki\",\"tags\":\"$:/tags/SideBar\",\"caption\":\"ChatGPT\",\"text\":\"@@height:calc(100vh - 120px);\\n<$chat-gpt history=\\\"$:/state/plugins/Gk0Wk/chat-gpt/side-bar-history\\\" scroll=\\\"yes\\\" model=\\\"gpt-3.5-turbo\\\" temperature=\\\"1\\\" max_tokens=\\\"512\\\" system_message=\\\"You are expert on TiddlyWiki. Output in Markdown format\\\" />\\n@@\\n\"},\"$:/plugins/Gk0Wk/chat-gpt/widget.js\":{\"title\":\"$:/plugins/Gk0Wk/chat-gpt/widget.js\",\"module-type\":\"widget\",\"type\":\"application/javascript\",\"Modern.TiddlyDev#Origin\":\"chatgpt-widget.ts\",\"text\":\"\\\"use strict\\\";async function getBytes(t,e){for(var s,r=t.getReader();!(s=await r.read()).done;)e(s.value)}function getLines(r){let i,n,a,o=!1;return function(t){void 0===i?(i=t,n=0,a=-1):i=concat(i,t);var e=i.length;let s=0;for(;n<e;){o&&(10===i[n]&&(s=++n),o=!1);let t=-1;for(;n<e&&-1===t;++n)switch(i[n]){case 58:-1===a&&(a=n-s);break;case 13:o=!0;case 10:t=n}if(-1===t)break;r(i.subarray(s,t),a),s=n,a=-1}s===e?i=void 0:0!==s&&(i=i.subarray(s),n-=s)}}function getMessages(a,o,c){let d=newMessage();const l=new TextDecoder;return function(t,e){if(0===t.length)null!=c&&c(d),d=newMessage();else if(0<e){var s=l.decode(t.subarray(0,e)),r=e+(32===t[e+1]?2:1),i=l.decode(t.subarray(r));switch(s){case\\\"data\\\":d.data=d.data?d.data+\\\"\\\\n\\\"+i:i;break;case\\\"event\\\":d.event=i;break;case\\\"id\\\":a(d.id=i);break;case\\\"retry\\\":var n=parseInt(i,10);isNaN(n)||o(d.retry=n)}}}}function concat(t,e){var s=new Uint8Array(t.length+e.length);return s.set(t),s.set(e,t.length),s}function newMessage(){return{data:\\\"\\\",event:\\\"\\\",id:\\\"\\\",retry:void 0}}var __rest=function(t,e){var s={};for(i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(s[i]=t[i]);if(null!=t&&\\\"function\\\"==typeof Object.getOwnPropertySymbols)for(var r=0,i=Object.getOwnPropertySymbols(t);r<i.length;r++)e.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(t,i[r])&&(s[i[r]]=t[i[r]]);return s},EventStreamContentType=\\\"text/event-stream\\\",DefaultRetryInterval=1e3,LastEventId=\\\"last-event-id\\\";function fetchEventSource(v,t){var{signal:e,headers:s,onopen:r,onmessage:m,onclose:w,onerror:y,openWhenHidden:i,fetch:b}=t,f=__rest(t,[\\\"signal\\\",\\\"headers\\\",\\\"onopen\\\",\\\"onmessage\\\",\\\"onclose\\\",\\\"onerror\\\",\\\"openWhenHidden\\\",\\\"fetch\\\"]);return new Promise((n,a)=>{const o=Object.assign({},s);o.accept||(o.accept=EventStreamContentType);let c;function t(){c.abort(),document.hidden||p()}i||document.addEventListener(\\\"visibilitychange\\\",t);let d=DefaultRetryInterval,l=0;function h(){document.removeEventListener(\\\"visibilitychange\\\",t),window.clearTimeout(l),c.abort()}null!=e&&e.addEventListener(\\\"abort\\\",()=>{h(),n()});const u=null!=b?b:window.fetch,g=null!=r?r:defaultOnOpen;async function p(){var t;c=new AbortController;try{var e=await u(v,Object.assign(Object.assign({},f),{headers:o,signal:c.signal}));await g(e),await getBytes(e.body,getLines(getMessages(t=>{t?o[LastEventId]=t:delete o[LastEventId]},t=>{d=t},m))),null!=w&&w(),h(),n()}catch(r){if(!c.signal.aborted)try{var s=null!=(t=null==y?void 0:y(r))?t:d;window.clearTimeout(l),l=window.setTimeout(p,s)}catch(i){h(),a(i)}}}p()})}function defaultOnOpen(t){var e=t.headers.get(\\\"content-type\\\");if(null==e||!e.startsWith(EventStreamContentType))throw new Error(`Expected content-type to be ${EventStreamContentType}, Actual: `+e)}var CHAT_COMPLETION_URL=\\\"https://api.openai.com/v1/chat/completions\\\",isChinese=()=>$tw.wiki.getTiddler(\\\"$:/language\\\").fields.text.includes(\\\"zh\\\"),renderConversation=({id:t,assistant:e,user:s})=>$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"chatgpt-conversation\\\",attributes:{\\\"chatgpt-conversation\\\":t},children:[$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"chatgpt-conversation-message chatgpt-conversation-user\\\",children:[$tw.utils.domMaker(\\\"p\\\",{text:s})]}),$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"chatgpt-conversation-message chatgpt-conversation-assistant\\\",innerHTML:$tw.wiki.renderText(\\\"text/html\\\",\\\"text/x-markdown\\\",e)})]}),renderChatingConversation=(t,e,s)=>{var r=$tw.utils.domMaker(\\\"pre\\\",{text:t?\\\"思考中...\\\":\\\"Thinking...\\\",style:{background:\\\"transparent\\\",marginTop:\\\"0\\\",marginBottom:\\\"0\\\",padding:\\\"0\\\"}});const i=$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"chatgpt-conversation chatgpt-conversation-chating\\\",children:[$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"chatgpt-conversation-message chatgpt-conversation-user\\\",children:[$tw.utils.domMaker(\\\"p\\\",{text:e})]}),$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"chatgpt-conversation-message chatgpt-conversation-assistant\\\",children:[$tw.utils.domMaker(\\\"p\\\",{children:[r]})]})]});return{conversation:i,answerBox:r,printError:t=>{s.removeChild(i),s.appendChild($tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"chatgpt-conversation chatgpt-conversation-error\\\",children:[$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"chatgpt-conversation-message chatgpt-conversation-user\\\",children:[$tw.utils.domMaker(\\\"p\\\",{text:e})]}),$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"chatgpt-conversation-message chatgpt-conversation-assistant\\\",text:t})]}))}}},import_widget=require(\\\"$:/core/modules/widgets/widget.js\\\"),ChatGPTWidget=class extends import_widget.widget{constructor(){super(...arguments),this.containerNodeTag=\\\"div\\\",this.containerNodeClass=\\\"\\\",this.tmpHistoryTiddler=\\\"$:/temp/Gk0Wk/ChatGPT/history-\\\"+Date.now(),this.historyTiddler=this.tmpHistoryTiddler,this.chatButtonText=$tw.wiki.getTiddlerText(\\\"$:/core/images/add-comment\\\"),this.scroll=!1,this.readonly=!1,this.chatGPTOptions={},this.systemMessage=\\\"\\\"}initialise(t,e){super.initialise(t,e),this.computeAttributes()}execute(){this.containerNodeTag=this.getAttribute(\\\"component\\\",\\\"div\\\"),this.containerNodeClass=this.getAttribute(\\\"className\\\",\\\"\\\"),this.historyTiddler=this.getAttribute(\\\"history\\\",\\\"\\\")||this.tmpHistoryTiddler,this.scroll=\\\"yes\\\"===(null==(e=null==(t=this.getAttribute(\\\"scroll\\\"))?void 0:t.toLowerCase)?void 0:e.call(t)),this.readonly=\\\"yes\\\"===(null==(e=null==(t=this.getAttribute(\\\"readonly\\\"))?void 0:t.toLowerCase)?void 0:e.call(t));var t=Number(this.getAttribute(\\\"temperature\\\")),e=Number(this.getAttribute(\\\"top_p\\\")),s=parseInt(this.getAttribute(\\\"max_tokens\\\"),10),r=Number(this.getAttribute(\\\"presence_penalty\\\")),i=Number(this.getAttribute(\\\"frequency_penalty\\\"));this.chatGPTOptions={model:this.getAttribute(\\\"model\\\",\\\"gpt-3.5-turbo\\\"),temperature:0<=t&&t<=2?t:void 0,top_p:0<=e&&e<=1?e:void 0,max_tokens:Number.isSafeInteger(s)&&0<s?s:void 0,presence_penalty:-2<=r&&r<=2?r:void 0,frequency_penalty:-2<=i&&i<=2?i:void 0,user:this.getAttribute(\\\"user\\\")},this.systemMessage=this.getAttribute(\\\"system_message\\\",\\\"\\\")}render(t,e){if($tw.browser){this.execute();const p=$tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":this.scroll?\\\"conversations-scroll\\\":\\\"conversations\\\"});var s=$tw.utils.domMaker(this.containerNodeTag,{\\\"class\\\":\\\"gk0wk-chatgpt-container \\\"+this.containerNodeClass,children:[p]});t.insertBefore(s,e),this.domNodes.push(s);try{if(!this.readonly){const i=isChinese(),n=$tw.utils.domMaker(\\\"input\\\",{\\\"class\\\":\\\"chat-input\\\",attributes:{type:\\\"text\\\",placeholder:i?\\\"输入一个问题...\\\":\\\"Ask a question...\\\"}}),v=$tw.utils.domMaker(\\\"button\\\",{\\\"class\\\":\\\"chat-button\\\",innerHTML:this.chatButtonText});s.appendChild($tw.utils.domMaker(\\\"div\\\",{\\\"class\\\":\\\"chat-box\\\",children:[n,v]}));let g=!1;const a=async()=>{if(!g){var t=$tw.wiki.getTiddlerText(\\\"$:/plugins/Gk0Wk/chat-gpt/openai-api-key\\\",\\\"\\\").trim();if(t){const c=n.value.trim();if(c){n.value=\\\"\\\",g=!0,v.disabled=!0;const{conversation:d,answerBox:l,printError:h}=renderChatingConversation(i,c,p);p.appendChild(d);try{var e=[];this.systemMessage&&e.push({role:\\\"system\\\",content:this.systemMessage}),e.push({role:\\\"user\\\",content:c});let n=\\\"\\\",a=\\\"\\\",o=0;const u=new AbortController;await fetchEventSource(CHAT_COMPLETION_URL,{method:\\\"POST\\\",signal:u.signal,body:JSON.stringify({...this.chatGPTOptions,messages:e,stream:!0}),headers:{Authorization:\\\"Bearer \\\"+t,\\\"Content-Type\\\":\\\"application/json\\\"},async onopen(t){t.ok&&\\\"text/event-stream\\\"===t.headers.get(\\\"content-type\\\")&&200===t.status||(u.abort(),h(await t.text()),g=!1,v.disabled=!1)},onmessage:({data:t})=>{var e,s;try{if(\\\"[DONE]\\\"===t){let t=[];try{t=JSON.parse($tw.wiki.getTiddlerText(this.historyTiddler)||\\\"[]\\\")}catch{}t.push({id:a,created:o,assistant:n,user:c}),$tw.wiki.addTiddler(new $tw.Tiddler(null!=(e=$tw.wiki.getTiddler(this.historyTiddler))?e:{},{title:this.historyTiddler,text:JSON.stringify(t)})),p.removeChild(d),p.appendChild(renderConversation(t[t.length-1])),u.abort(),g=!1,v.disabled=!1}else{var r=JSON.parse(t);a=r.id,o=r.created,n=(\\\"\\\"+n+(null!=(s=r.choices[0].delta.content)?s:\\\"\\\")).trimStart(),l.innerText=n+\\\"█\\\"}}catch(i){console.error(i),h(String(i)),u.abort(),g=!1,v.disabled=!1}p.scrollTop=p.scrollHeight},onerror:t=>{console.error(t),h(String(t)),u.abort(),g=!1,v.disabled=!1}})}catch(s){console.error(s),h(String(s))}}}}};v.onclick=a,n.addEventListener(\\\"keydown\\\",function(t){\\\"Enter\\\"!==t.code||t.shiftKey||(t.preventDefault(),a())})}let t=[];try{t=JSON.parse($tw.wiki.getTiddlerText(this.historyTiddler)||\\\"[]\\\")}catch{}for(const o of t)p.appendChild(renderConversation(o))}catch(r){console.error(r),s.textContent=String(r)}}}refresh(t){var e=this.computeAttributes();return 0<$tw.utils.count(e)?(this.refreshSelf(),!0):!(null==(e=t[this.historyTiddler])||!e.deleted||(this.refreshSelf(),0))}};exports[\\\"chat-gpt\\\"]=ChatGPTWidget;\"},\"$:/plugins/Gk0Wk/chat-gpt/chatgpt-widget.css\":{\"title\":\"$:/plugins/Gk0Wk/chat-gpt/chatgpt-widget.css\",\"tags\":[\"$:/tags/Stylesheet\"],\"type\":\"text/css\",\"Modern.TiddlyDev#Origin\":\"style.css\",\"text\":\".gk0wk-chatgpt-container{height:100%;width:100%;display:flex;padding:10px 0;flex-direction:column}.gk0wk-chatgpt-container .conversations{width:100%;flex-grow:1}.gk0wk-chatgpt-container .conversations-scroll{height:0;width:100%;flex-grow:1;overflow-y:auto}.gk0wk-chatgpt-container .chat-box{width:100%;display:flex;border:1.5px solid #888a;border-radius:5px;background:#8881}.gk0wk-chatgpt-container .chat-input{flex-grow:1;padding-left:10px;font-size:16px}.gk0wk-chatgpt-container .chat-button{height:45px;width:45px;font-size:20px}.gk0wk-chatgpt-container .chatgpt-conversation{display:flex;flex-direction:column}.gk0wk-chatgpt-container .chatgpt-conversation-assistant{background-image:linear-gradient(0deg,#8883,#8883)}.gk0wk-chatgpt-container .chatgpt-conversation-error .chatgpt-conversation-assistant{color:red}.gk0wk-chatgpt-container .chatgpt-conversation-user{font-weight:750}.gk0wk-chatgpt-container .chatgpt-conversation-message{padding:10px 20px}\"}}}","Modern.TiddlyDev#SHA256-Hashed":"ddfdd755721616e881bef558d842a211739338678c2d7c4956664abfbb181015"}